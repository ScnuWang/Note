---
title: 数据抓取 
tags: 源码
grammar_cjkRuby: true
---

``` python?linenums
import requests
import json
import pymysql
import re
import time
import sys
#引入python中的traceback模块，跟踪错误
import traceback
from urllib import parse


#  项链

# 构建请求地址

        # 中国大陆
website_url = "https://www.swarovski.com.cn"
url = "https://www.swarovski.com.cn/Web_CN/zh/json/json-result?"
query_term = "&@QueryTerm=*&CategoryUUIDLevelX=tfYKaSUCEOsAAAEn_NtToUKM&CategoryUUIDLevelX%2FtfYKaSUCEOsAAAEn_NtToUKM=EjEKaVgfTq0AAAFjMgl6fYzt&CategoryUUIDLevelX%2FtfYKaSUCEOsAAAEn_NtToUKM%2FEjEKaVgfTq0AAAFjMgl6fYzt=8E8KaVgfTQYAAAFjiwl6fYzt&@Sort.FFSort=0&@Page="

        # 中国香港
#url = "https://www.swarovski.com/Web_HK/zh/json/json-result?"
#query_term = "&@QueryTerm=*&CategoryUUIDLevelX=fQcKaSUCzHcAAAEnktxToUKM&CategoryUUIDLevelX%2FfQcKaSUCzHcAAAEnktxToUKM=fk0KaVgfKRcAAAFjv9t6fYxb&CategoryUUIDLevelX%2FfQcKaSUCzHcAAAEnktxToUKM%2Ffk0KaVgfKRcAAAFjv9t6fYxb=xxcKaVgfHFgAAAFjvtt6fYxb&@Sort.FFSort=0&@Page=1"

        # 德国
#url = "https://www.swarovski.com/Web_DE/de/json/json-result?"
#query_term = "&@QueryTerm=*&CategoryUUIDLevelX=B8kKaSUCmAEAAAEnLNBToUKM&CategoryUUIDLevelX%2FB8kKaSUCmAEAAAEnLNBToUKM=KdcKaVgfUt4AAAFjkPF6fYwv&CategoryUUIDLevelX%2FB8kKaSUCmAEAAAEnLNBToUKM%2FKdcKaVgfUt4AAAFjkPF6fYwv=aZkKaVgf510AAAFjw_F6fYwv&@Sort.FFSort=0&@Page=1"


# 组装请求地址
def encode_url(url, query_term, page_count):
    query_term = query_term + str(page_count)
    prarms = {'SearchParameter':query_term,'PageSize':48,'View':'M'}
    encode_prarms = parse.urlencode(prarms)
    url_encode = url+encode_prarms
    return url_encode


# 获取产品总页数
page_count = 1
response = json.loads(requests.get(encode_url(url,query_term,page_count)).text)
print(response['SearchResult']['PageCount'])

# 保存数据至是数据库

# 打开数据库连接
db = pymysql.connect("localhost", "root", "admin", "data")
# 使用cursor()方法获取操作游标
cursor = db.cursor()

# 解析数据
while page_count <= response['SearchResult']['PageCount']:
    response_json = json.loads(requests.get(encode_url(url,query_term,page_count)).text)

    products = response_json['SearchResult']['Products']
    # print(products)
    for product in products:
        # print(product)
        original_id = product['SKU']
        print(original_id)
        brand_name = 'Swarovski'
        sales_location = '中国大陆'
        product_name = product['Name']
        product_price = int(re.sub('\D',"",product['Price']))/100
        original_currency = re.sub(r'[^A-Z]', '', product['Price'])
        product_url = product['DetailPage']
        product_image = website_url + product['ProductImage']
        product_thumbnail = website_url = product['Thumbnail']
        if product['OldPrice'] == "":
            old_price = 0.00
        else:
            old_price = int(re.sub('\D',"",product['OldPrice']))/100
        nick_name = ""
        cny_product_price = 0.00
        cny_exchange_rate = 0.00
        product_status = '在售' # 1：在售；2：下架；3新上；4：异常
        update_time = time.strftime("%Y-%m-%d %H:%M:%S", time.localtime())

        # 保存数据为文件

        params = (original_id,brand_name,sales_location,product_name,product_price,original_currency, product_url)
        # SQL 插入语句

        try:
            # 执行sql语句
            cursor.execute("INSERT INTO cj_product(original_id,brand_name,sales_location,product_name,product_price,original_currency, product_url)VALUES ('s%','s%','s%','s%','d%','d%','s%')" % (original_id,brand_name,sales_location,product_name,product_price,original_currency, product_url))
            # 提交到数据库执行
            db.commit()
        except Exception:
            # 如果发生错误则回滚
            print(Exception)
            db.rollback()
    page_count += 1

# 关闭数据库连接
db.close()


```